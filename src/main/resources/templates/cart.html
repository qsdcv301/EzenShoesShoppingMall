<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Shoes Shop</title>
    <!-- 부트스트랩 아이콘 사용 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet"/>
    <link href="/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="/css/style.css" rel="stylesheet"/>
    <script src="/js/jquery-1.12.4.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/popper.min.js"></script>
    <script src="/js/script.js"></script>
   
</head>
<body>
    <header th:replace="~{fragments/header :: header}"></header>

    <div class="container my-4">
        <div class="row">
            <!-- 주문 상품 목록 섹션 -->
            <div class="col-md-8">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2>주문 상품 요약</h2>
                    <div>
                        <button id="select-all" class="btn btn-primary mr-2">전체 선택</button>
                        <button id="deselect-all" class="btn btn-secondary mr-2" style="display: none;">전체 선택 해제</button>
                        <button id="delete-selected" class="btn btn-danger">선택 삭제</button>
                    </div>
                </div>

                <div id="product-list">
                    <!-- 상품 카드 루프 -->
                    <div class="product-card card mt-3" th:each="product, index : ${productList}" data-price="${product.price}">
                        <input type="hidden" th:value="${product.id}" name="product-id"/>
                        <div class="card-body d-flex align-items-center">
                            <input type="checkbox" class="mr-3 product-checkbox"/>
                            <img class="img-thumbnail mr-3" th:alt="${product.name}" th:src="${imageUrls.get(index.index)}"/>
                            <div>
                                <h5 class="card-title" th:text="${product.name}">나이키 에어맥스</h5>
                                <p class="card-text product-info" th:text="${product.description}">사이즈: 250 / 수량: 1개</p>
                                <p class="card-text">가격: <span class="product-price" th:text="${product.price}">89,000 EZ코인</span></p>
                                <button class="btn btn-sm btn-dark edit-btn">옵션 변경</button>
                                <div class="edit-form" style="display: none;">
                                    <div class="form-group">
                                        <label for="size-1">사이즈:</label>
                                        <select id="size-1" class="form-control size-select">
                                            <option value="240">240</option>
                                            <option value="250" selected>250</option>
                                            <option value="260">260</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="quantity-1">수량:</label>
                                        <input type="number" id="quantity-1" class="form-control quantity-input" value="1" min="1"/>
                                    </div>
                                    <button class="btn btn-sm btn-primary save-btn">저장</button>
                                    <button class="btn btn-sm btn-secondary cancel-btn">취소</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- /상품 카드 루프 -->
                </div>
            </div>

            <!-- 가격 정보 섹션 -->
            <div class="col-md-4 total-price">
                <h2>Total Price</h2>
                <p>주문 상품 수: <span id="item-count">0</span></p>
                <p>상품 총액: <span id="total-amount">0 EZ코인</span></p>
                <p>배송비: <span id="shipping-cost">3,000 EZ코인</span></p>
                <hr/>
                <p><strong>전체 주문 금액: </strong><span id="final-amount">0 EZ코인</span></p>
                <button class="btn btn-primary btn-block">구매하기</button>
            </div>
        </div>
    </div>

    <footer th:replace="~{fragments/footer :: footer}"></footer>

    <!-- 결제 모달 -->
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalLabel">결제 정보</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="payment-summary"></div>
                    <div id="insufficient-funds" class="text-danger mt-3" style="display: none;">
                        보유 코인이 부족합니다. <button id="recharge-button" class="btn btn-warning btn-sm ml-2">충전하기</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" id="confirm-payment">결제 하기</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            const userBalance = 200000;

            function updateTotalPrice() {
                let total = 0;
                let itemCount = 0;
                $('.product-checkbox:checked').each(function () {
                    const productCard = $(this).closest('.product-card');
                    const price = parseInt(productCard.data('price'));
                    total += price;
                    itemCount++;
                });

                $('#item-count').text(itemCount);
                $('#total-amount').text(total + ' EZ코인');

                const shipping = total >= 50000 ? 0 : 3000;
                $('#shipping-cost').text(shipping + ' EZ코인');
                $('#final-amount').text((total + shipping) + ' EZ코인');
            }

            $('#product-list').on('click', '.edit-btn', function () {
                const productCard = $(this).closest('.product-card');
                productCard.find('.edit-form').show();
                $(this).hide();
            });

            $('#product-list').on('click', '.save-btn', function () {
                const productCard = $(this).closest('.product-card');
                const newSize = productCard.find('.size-select').val();
                const newQuantity = productCard.find('.quantity-input').val();

                productCard.find('.product-info').text(`사이즈: ${newSize} / 수량: ${newQuantity}개`);
                updateTotalPrice();

                productCard.find('.edit-form').hide();
                productCard.find('.edit-btn').show();
            });

            $('#select-all').click(function () {
                $('.product-checkbox').prop('checked', true);
                updateTotalPrice();
            });

            $('#delete-selected').click(function () {
                $('.product-checkbox:checked').closest('.product-card').remove();
                updateTotalPrice();
            });

            $('.btn-primary.btn-block').click(function () {
                let totalAmount = parseInt($('#final-amount').text().replace(/[^0-9]/g, ''));
                if (totalAmount > userBalance) {
                    $('#insufficient-funds').show();
                } else {
                    alert('결제가 완료되었습니다.');
                }
            });
        });
    </script>
</body>
</html>